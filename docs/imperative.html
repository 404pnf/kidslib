<!DOCTYPE html>

<html>
<head>
  <title>目的</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-">目的</h1>
<p>在当前目录生成内容随机的文件。文件大小从1G到5G不等。文件总大小同过命令行参数设定。</p>
<h1 id="-">使用说明</h1>
<pre><code>ruby script.rb total_file_size
</code></pre><p>命令行跟总共要生成的文件大小。单位是GB。</p>
<p>举例：</p>
<p>不加任何参数执行脚本默认生成100GB文件</p>
<pre><code>ruby script.rb
</code></pre><p>要生成总共500GB的文件</p>
<pre><code>ruby script.rb 500
</code></pre><p>要生成总共1.5TB的文件</p>
<pre><code>ruby script.rb 1500
</code></pre><hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">require</span> <span class="string">'securerandom'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1 id="-">用模块封装，就是一个命名空间</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">module</span> <span class="title">GenHugeFile</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>BLOCKDATA的大小是1MB</p>
<p>我开始的随机字符串小一点，后面写文件的时候多写1000多次，这样可能快一些。</p>
<p>不用1024和1000，省得一看就是生成的</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="constant">BLOCKDATA</span> = -&gt; { <span class="constant">SecureRandom</span>.random_bytes(<span class="number">1024</span> * <span class="number">1193</span>) }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>主函数</p>
<p>integer -&gt; side effect</p>
<p>参数是文件总大小</p>
<p>不要用File.write，因为它需要一次性地在内存中生成很多GB的字符串并写入文件，会因为内存不够无法正确执行</p>
<p>File.open(filename, &#39;a&#39;) 避免了内存不足的问题。我们每次只写一小块，写n多次。</p>
<p>1013 * size 是因为 BLOCKDATA 是 mb， 要写的文件是 gb</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">(total_file_size=<span class="number">100</span>, single_file_max_size = <span class="number">5</span>)</span></span>
    n = <span class="number">0</span>
    <span class="keyword">while</span> n &lt; total_file_size
      filename =  <span class="string">"ziyuan-jiami-<span class="subst">#{<span class="constant">SecureRandom</span>.hex(<span class="number">6</span>)}</span>.data"</span>
      size = <span class="constant">SecureRandom</span>.random_number single_file_max_size
      (<span class="number">1013</span> * size).times <span class="keyword">do</span>
        <span class="constant">File</span>.open(filename, <span class="string">'a'</span>) { |f| f.puts((<span class="constant">GenHugeFile::BLOCKDATA</span>).call) }
      <span class="keyword">end</span>
      n += size
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  module_function <span class="symbol">:gen</span>
<span class="keyword">end</span>

<span class="constant">GenHugeFile</span>.gen <span class="constant">ARGV</span>[<span class="number">0</span>].to_i</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
