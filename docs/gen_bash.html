<!DOCTYPE html>

<html>
<head>
  <title>目的</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="gen_bash.html">
                gen_bash.rb
              </a>
            
              
              <a class="source" href="gen_files_using_ruby_fp.html">
                gen_files_using_ruby_fp.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-">目的</h1>
<p>在当前目录生成内容随机的文件。文件大小从1G到5G不等。文件总大小同过命令行参数设定。</p>
<h1 id="-">使用说明</h1>
<pre><code>ruby script.rb total_file_size
</code></pre><p>命令行跟总共要生成的文件大小。单位是GB。</p>
<p>举例：</p>
<p>不加任何参数执行脚本默认生成100GB文件</p>
<pre><code>ruby script.rb
</code></pre><p>要生成总共500GB的文件</p>
<pre><code>ruby script.rb 500
</code></pre><p>要生成总共1.5TB的文件</p>
<pre><code>ruby script.rb 1500
</code></pre><hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">require</span> <span class="string">'securerandom'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>命名空间</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">module</span> <span class="title">U</span></span>
  extend <span class="keyword">self</span> <span class="comment"># 让所有定义的参数都是module_function</span>

  <span class="function"><span class="keyword">def</span> <span class="title">blockdata</span></span>
    -&gt; { <span class="constant">SecureRandom</span>.random_bytes(<span class="number">1024</span> * <span class="number">1193</span>) }   <span class="comment"># 大小约1MB</span>
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">def</span> <span class="title">random_filename</span></span>
    -&gt; { <span class="string">"ziyuan-jiami-<span class="subst">#{<span class="constant">SecureRandom</span>.hex(<span class="number">4</span>)}</span>.data"</span> }
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">def</span> <span class="title">single_file_max_size</span></span>
    <span class="number">5</span>
  <span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>因为raondom出的数可能是0，所以需要加1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">numbers</span></span>
    <span class="constant">Enumerator</span>.new <span class="keyword">do</span> |y|
      loop { y &lt;&lt; <span class="constant">SecureRandom</span>.random_number(single_file_max_size) + <span class="number">1</span> }
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">def</span> <span class="title">filenames</span></span>
    <span class="constant">Enumerator</span>.new <span class="keyword">do</span> |y|
      loop { y &lt;&lt; random_filename.call }
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="variable">@n</span> = <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>[[6655, &quot;ziyuan-jiami-3dd9937c.data&quot;], [2662, &quot;ziyuan-jiami-82fff573.data&quot;], [3993, &quot;ziyuan-jiami-033706fd.data&quot;], [1331, &quot;ziyuan-jiami-18f2d5ad.data&quot;], [5324, &quot;ziyuan-jiami-9c69a104.data&quot;] ... ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">size_filename_pair</span><span class="params">(total_file_size)</span></span>
    numbers.each
           .take_while { |e| <span class="variable">@n</span> += e; <span class="variable">@n</span> &lt; total_file_size }
           .zip(filenames)
           .map { |gb, filename| [gb * <span class="number">1331</span>, filename] }
  <span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>module_function :final_pair</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>p U.numbers.take 10
p U.size_filename_pair 60</p>
<p>命名空间</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">module</span> <span class="title">GenHugeFile</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>include U # 没有，只对 class instance 起作用 ； 即使写了，在self.method中仍需要写U</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">(total_file_size)</span></span>
    <span class="constant">U</span>.size_filename_pair(total_file_size).each <span class="keyword">do</span> |size_in_mb, filename|
      p <span class="string">"writing <span class="subst">#{filename}</span>, <span class="subst">#{size_in_mb}</span>MB"</span>
      system(<span class="string">"dd if=/dev/zero of=<span class="subst">#{filename}</span> bs=1 count=0 seek=<span class="subst">#{size_in_mb}</span>m"</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  module_function <span class="symbol">:gen</span>
<span class="keyword">end</span>

<span class="constant">GenHugeFile</span>.gen <span class="constant">ARGV</span>[<span class="number">0</span>].to_i</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
